<main>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <div class="entities">
      {{#if contacts.length}}
         <h1>–ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏</h1>
          <ul>
            {{#each contacts}}
              <li>
                <div class="entity-content">
                <a href="/contacts/{{this.id}}"></a> - {{this.address}}, {{this.phone}}, {{this.email}}, {{this.mapsLink}}
                <a href="/contact-edit/{{this.id}}">‚úèÔ∏è</a>
                <form action="/contacts/{{this.id}}" method="POST" style="display:inline;">
                  <input type="hidden" name="_method" value="DELETE">
                  <a href="/contact-delete/{{this.id}}">üóëÔ∏è</a>
                </form>
                </div>
              </li>
            {{/each}}
          </ul>
      {{else}}
        <p>–ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
      {{/if}}
    <div class="do-entity-add">
    <a href="/contact-add">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
  </div>
  </div>

  <script>
    toastr.options = { positionClass: 'toast-top-right', timeout: 5000 };

    function setupEventSource() {
      const eventSource = new EventSource('http://localhost:8082/contact-events');

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.message) {
            toastr.info(data.message);
          }
        } catch (e) {
          console.error('SSE parse error:', e);
        }
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—à–∏–±–æ–∫ SSE
      eventSource.onerror = (e) => {
        console.error('SSE error:', e);
        eventSource.close();
        setTimeout(setupEventSource, 2000); // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫
      };
    }
    document.addEventListener('DOMContentLoaded', setupEventSource, (e) => {
      e.preventDefault();
    });
  </script>
</main>